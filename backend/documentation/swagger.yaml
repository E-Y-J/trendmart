#app/static/swagger.yaml

swagger: '2.0'
info:
  title: "TRENDMART API"
  description: "API documentation for the TRENDMART application."
  version: "1.0.0"
host: "localhost:8000"
basePath: "/"
schemes:
  - "http"
consumes:
  - "application/json"
produces:
  - "application/json"



# =========================
# Paths
# =========================
paths: 
  /bulk/add:
    post:
      tags:
        - Catalog
      summary: Bulk add categories, subcategories, and products
      description: |
        Ingest a nested structure of categories → subcategories → products.
        Entries are upserted to avoid duplicates:
        - Category uniqueness by slugified main_category
        - Subcategory uniqueness by slugified "{category-slug}-{name}"
        - Product uniqueness by SKU (if provided) or (name + subcategory)
      parameters:
        - in: body
          name: body
          required: true
          schema:
            $ref: '#/definitions/BulkAddRequest'
      responses:
        200:
          description: Upsert summary and created/updated items
          schema:
            $ref: '#/definitions/BulkAddResponse'
        400:
          description: Validation error
          schema:
            $ref: '#/definitions/ErrorResponse'
        409:
          description: Integrity error (e.g., SKU collisions after retries)
          schema:
            $ref: '#/definitions/ErrorResponse'
        500:
          description: Server error
          schema:
            $ref: '#/definitions/ErrorResponse'

  /recommendations/health:
    get:
      tags:
        - Recommendations
      summary: Health/status for recommendation service
      responses:
        200:
          description: Health info
          schema:
            type: object
            properties:
              status:
                type: string
                example: ok
              vector_store:
                type: object
                properties:
                  total_products:
                    type: integer
                    example: 180
                  embedding_dimension:
                    type: integer
                    example: 384
                  model_name:
                    type: string
                    example: all-MiniLM-L6-v2

  /recommendations/search:
    post:
      tags:
        - Recommendations
      summary: Semantic product search
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            properties:
              query:
                type: string
                example: comfortable running sneakers
              top_k:
                type: integer
                example: 5
      responses:
        200:
          description: Search results
          schema:
            $ref: '#/definitions/ProductCardList'

  /recommendations/similar/{product_id}:
    get:
      tags:
        - Recommendations
      summary: Find products similar to a given product id
      parameters:
        - in: path
          name: product_id
          required: true
          type: integer
        - in: query
          name: top_k
          required: false
          type: integer
          default: 3
      responses:
        200:
          description: Similar products
          schema:
            $ref: '#/definitions/ProductCardList'

  /recommendations/category/{name}:
    get:
      tags:
        - Recommendations
      summary: Category products (exact, semantic or hybrid)
      parameters:
        - in: path
          name: name
          required: true
          type: string
        - in: query
          name: top_k
          type: integer
          default: 3
        - in: query
          name: mode
          type: string
          enum: [exact, semantic, hybrid]
          default: exact
      responses:
        200:
          description: Category products
          schema:
            $ref: '#/definitions/ProductCardList'

  /recommendations/answer:
    post:
      tags:
        - Recommendations
      summary: Ask a question and get an answer with relevant products
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            properties:
              question:
                type: string
                example: What are some waterproof trail shoes?
              top_k:
                type: integer
                example: 5
      responses:
        200:
          description: Answer and products
          schema:
            type: object
            properties:
              answer:
                type: string
              source_ids:
                type: array
                items:
                  type: integer
              products:
                type: array
                items:
                  $ref: '#/definitions/ProductCard'
              raw:
                type: object
              retrieved:
                type: array
                items:
                  type: object
              elapsed_ms:
                type: integer

  /recommendations/by_ids:
    post:
      tags:
        - Recommendations
      summary: Resolve product ids to product cards
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            properties:
              ids:
                type: array
                items:
                  type: integer
      responses:
        200:
          description: Product cards
          schema:
            $ref: '#/definitions/ProductCardList'

  /recommendations/reindex:
    post:
      tags:
        - Recommendations
      summary: Force reload the product index file into memory
      responses:
        200:
          description: Reloaded status
          schema:
            type: object
            properties:
              status:
                type: string
                example: reloaded
              stats:
                type: object
  
  /auth/register: # Authentication - Register
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Create a new user account with email and password. Returns user data and JWT tokens for immediate login.
      parameters:
        - in: body
          name: body
          description: Registration data
          required: true
          schema:
            $ref: '#/definitions/RegisterPayload'
      responses:
        201:
          description: User registered successfully
          schema:
            $ref: '#/definitions/RegisterResponse'
          examples:
            application/json:
              {
                "email": "user@example.com",
              }
        400:
          description: Validation error or email already exists
          schema:
            $ref: '#/definitions/ErrorResponse'
          examples:
            application/json:
              {
                "status": "error",
                "message": "A user with this email already exists!"
              }

  /auth/login: # Authentication - Login
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user with email and password. Returns JWT access and refresh tokens.
      parameters:
        - in: body
          name: body
          description: Login credentials
          required: true
          schema:
            $ref: '#/definitions/LoginPayload'
      responses:
        200:
          description: Login successful
          schema:
            $ref: '#/definitions/TokenResponse'
          examples:
            application/json:
              {
                "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
                "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
                "token_type": "Bearer",
                "expires_in": 3600
              }
        401:
          description: Invalid credentials
          schema:
            $ref: '#/definitions/ErrorResponse'
          examples:
            application/json:
              {
                "error": "Invalid credentials"
              }

  /auth/protected: # Protected Route - Test
    get:
      tags:
        - Authentication
      summary: Test protected route
      description: Test endpoint to verify JWT authentication is working
      security:
        - BearerAuth: []
      responses:
        200:
          description: Authentication successful
          schema:
            $ref: '#/definitions/ProtectedResponse'
          examples:
            application/json:
              {
                "message": "Hello! You are successfully authenticated!",
                "user_id": 1,
                "email": "user@example.com",
              }
        401:
          description: Unauthorized - Invalid or missing token
          schema:
            $ref: '#/definitions/ErrorResponse'
          examples:
            application/json:
              {
                "msg": "Missing Authorization Header"
              }
          
# =========================
# Security Definitions
# =========================
securityDefinitions:
  BearerAuth:
    type: apiKey
    name: Authorization
    in: header
    description: "Enter 'Bearer' followed by your JWT token. Example: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."

# =========================
# Definitions (Schemas)
# =========================  
definitions: 
  # -----------------
  # Bulk Add Schemas
  # -----------------
  ProductIn:
    type: object
    required: [name]
    properties:
      id:
        type: integer
        description: Optional id from sample data (not persisted)
      external_id:
        type: string
        description: Optional external id for future use
      sku:
        type: string
        description: Optional SKU. If omitted, one will be derived and truncated to 50 chars.
      name:
        type: string
        example: "ASUS ZenBook X14"
      description:
        type: string
        example: ""
      price:
        type: number
        format: float
        example: 1299.99
      rating:
        type: number
        format: float
        description: Not stored in DB (used for embeddings/context)
        example: 4.5
      tags:
        type: array
        items:
          type: string
        example: ["brand-asus", "os-windows"]
      image_url:
        type: string
        example: "https://placehold.co/800x800?text=ASUS%20ZenBook%20X14"
      image_thumb_url:
        type: string
        example: "https://placehold.co/300x300?text=ASUS%20ZenBook%20X14"
      image_attribution:
        type: string
        example: "Placeholder"

  SubcategoryIn:
    type: object
    required: [name]
    properties:
      name:
        type: string
        example: "Laptops"
      products:
        type: array
        items:
          $ref: '#/definitions/ProductIn'
      related_subcategories:
        type: array
        items:
          type: string
        description: Present in sample data; not persisted

  CategoryIn:
    type: object
    required: [main_category]
    properties:
      main_category:
        type: string
        example: "Electronics"
      subcategories:
        type: array
        items:
          $ref: '#/definitions/SubcategoryIn'

  BulkAddRequest:
    type: object
    required: [categories]
    properties:
      categories:
        type: array
        items:
          $ref: '#/definitions/CategoryIn'
    example:
      categories:
        - main_category: Electronics
          subcategories:
            - name: Laptops
              products:
                - name: ASUS ZenBook X14
                  price: 1299.99
                  rating: 4.5
                  tags: [brand-asus, os-windows]
                  image_url: https://placehold.co/800x800?text=ASUS%20ZenBook%20X14
                  image_thumb_url: https://placehold.co/300x300?text=ASUS%20ZenBook%20X14
                  image_attribution: Placeholder

  BulkAddProductResult:
    type: object
    properties:
      id:
        type: integer
      sku:
        type: string
      name:
        type: string

  BulkAddSubcategoryResult:
    type: object
    properties:
      id:
        type: integer
      name:
        type: string
      products:
        type: array
        items:
          $ref: '#/definitions/BulkAddProductResult'

  BulkAddCategoryResult:
    type: object
    properties:
      id:
        type: integer
      name:
        type: string
      subcategories:
        type: array
        items:
          $ref: '#/definitions/BulkAddSubcategoryResult'

  BulkAddResponse:
    type: object
    properties:
      status:
        type: string
        example: ok
      created:
        type: object
        properties:
          categories:
            type: integer
            example: 1
          subcategories:
            type: integer
            example: 1
          products:
            type: integer
            example: 10
      updated:
        type: object
        properties:
          categories:
            type: integer
            example: 0
          subcategories:
            type: integer
            example: 0
          products:
            type: integer
            example: 0
      results:
        type: object
        properties:
          categories:
            type: array
            items:
              $ref: '#/definitions/BulkAddCategoryResult'

  ProductCard:
    type: object
    properties:
      id:
        type: integer
      sku:
        type: string
      name:
        type: string
      description:
        type: string
      price:
        type: number
        format: float
      rating:
        type: number
        format: float
      tags:
        type: array
        items:
          type: string
      primary_image:
        type: string
      thumbnail:
        type: string
      images:
        type: array
        items:
          type: string
      subcategory:
        type: string
      main_category:
        type: string
      category_info:
        type: object
      times_click_on:
        type: integer
      score:
        type: number
        format: float

  ProductCardList:
    type: object
    properties:
      results:
        type: array
        items:
          $ref: '#/definitions/ProductCard'
      count:
        type: integer
      elapsed_ms:
        type: integer
  # Authentication Schemas
  RegisterPayload:
    type: object
    required:
      - email
      - password
    properties:
      email:
        type: string
        format: email
        example: "user@example.com"
        description: "Valid email address for the user"
      password:
        type: string
        minLength: 8
        example: "SecurePass123!"
        description: "Password must be at least 8 characters with uppercase, lowercase, number, and special character"

  RegisterResponse:
    type: object
    properties:
      email:
        type: string
        example: "user@example.com"
      
  LoginPayload:
    type: object
    required:
      - email
      - password
    properties:
      email:
        type: string
        format: email
        example: "user@example.com"
      password:
        type: string
        example: "SecurePass123!"

  TokenResponse:
    type: object
    properties:
      access_token:
        type: string
        example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
        description: "JWT access token for API authentication"
      refresh_token:
        type: string
        example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
        description: "JWT refresh token for getting new access tokens"
      token_type:
        type: string
        example: "Bearer"
        description: "Token type (always 'Bearer')"
      expires_in:
        type: integer
        example: 3600
        description: "Token expiration time in seconds"

  ProtectedResponse:
    type: object
    properties:
      message:
        type: string
        example: "Hello! You are successfully authenticated!"
      user_id:
        type: integer
        example: 1
      email:
        type: string
        example: "user@example.com"

  ErrorResponse:
    type: object
    properties:
      error:
        type: string
        example: "Error message"
      status:
        type: string
        example: "error"
      message:
        type: string
        example: "Detailed error message"
      details:
        type: object
        description: "Validation error details"



